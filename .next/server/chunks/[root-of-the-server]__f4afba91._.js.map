{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/Antigravity/AI%EC%97%B0%EB%A7%90%EC%A0%95%EC%82%B0V3/app/api/ocr/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\n\r\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY;\r\n// gemini-2.0-flash 모델 사용 (Vision 지원)\r\nconst GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';\r\n\r\ninterface OcrItem {\r\n    category: string;\r\n    merchant: string;\r\n    amount: number;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        if (!GEMINI_API_KEY) {\r\n            return NextResponse.json(\r\n                { error: 'GEMINI_API_KEY가 설정되지 않았습니다.' },\r\n                { status: 500 }\r\n            );\r\n        }\r\n\r\n        const { images } = await request.json();\r\n\r\n        if (!images || !Array.isArray(images) || images.length === 0) {\r\n            return NextResponse.json(\r\n                { error: '이미지가 제공되지 않았습니다.' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const allItems: OcrItem[] = [];\r\n\r\n        for (const imageBase64 of images) {\r\n            // base64 데이터에서 prefix 제거\r\n            const base64Data = imageBase64.replace(/^data:image\\/\\w+;base64,/, '');\r\n\r\n            const prompt = `이 이미지는 영수증, 카드 명세서, 또는 지출 관련 문서입니다.\r\n이미지에서 지출 항목을 추출하여 JSON 배열로 반환해주세요.\r\n\r\n각 항목은 다음 형식으로 반환해주세요:\r\n{\r\n    \"category\": \"카테고리명\",\r\n    \"merchant\": \"가맹점/상호명\",\r\n    \"amount\": 금액(숫자만)\r\n}\r\n\r\n카테고리는 반드시 다음 중 하나를 선택해주세요:\r\n- \"신용카드\": 일반 신용카드 결제\r\n- \"체크카드\": 체크카드/직불카드 결제\r\n- \"현금영수증\": 현금영수증 발행 결제\r\n- \"대중교통\": 버스, 지하철, 택시, KTX 등 교통수단\r\n- \"보험료\": 보험사 납입금\r\n- \"의료비\": 병원, 약국, 의원 등 의료비 지출\r\n- \"전통시장\": 전통시장, 재래시장 지출\r\n- \"문화체육\": 영화관, 서점, 헬스장, 공연 등\r\n\r\n금액은 반드시 숫자만 포함해주세요 (쉼표, '원' 제거).\r\n가맹점명이 불분명하면 \"-\"로 표시해주세요.\r\n\r\n응답은 반드시 JSON 배열만 반환해주세요. 다른 텍스트 없이 오직 JSON 배열만요.\r\n예시: [{\"category\": \"신용카드\", \"merchant\": \"스타벅스\", \"amount\": 5500}]\r\n\r\n만약 이미지에서 지출 항목을 찾을 수 없다면 빈 배열 []을 반환해주세요.`;\r\n\r\n            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    contents: [{\r\n                        parts: [\r\n                            { text: prompt },\r\n                            {\r\n                                inline_data: {\r\n                                    mime_type: 'image/jpeg',\r\n                                    data: base64Data\r\n                                }\r\n                            }\r\n                        ]\r\n                    }],\r\n                    generationConfig: {\r\n                        temperature: 0.1,\r\n                        maxOutputTokens: 2048,\r\n                    }\r\n                })\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const errorData = await response.text();\r\n                console.error('Gemini API Error:', errorData);\r\n                continue;\r\n            }\r\n\r\n            const data = await response.json();\r\n            const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';\r\n\r\n            // JSON 파싱 시도\r\n            try {\r\n                // 마크다운 코드 블록 제거\r\n                let jsonStr = textContent.trim();\r\n                if (jsonStr.startsWith('```json')) {\r\n                    jsonStr = jsonStr.replace(/^```json\\s*/, '').replace(/```\\s*$/, '');\r\n                } else if (jsonStr.startsWith('```')) {\r\n                    jsonStr = jsonStr.replace(/^```\\s*/, '').replace(/```\\s*$/, '');\r\n                }\r\n\r\n                const items = JSON.parse(jsonStr);\r\n                if (Array.isArray(items)) {\r\n                    allItems.push(...items.map((item: OcrItem) => ({\r\n                        category: item.category || '신용카드',\r\n                        merchant: item.merchant || '-',\r\n                        amount: typeof item.amount === 'number' ? item.amount : parseInt(String(item.amount).replace(/[^0-9]/g, '')) || 0\r\n                    })).filter((item: OcrItem) => item.amount > 0));\r\n                }\r\n            } catch (parseError) {\r\n                console.error('JSON Parse Error:', parseError, 'Content:', textContent);\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({ items: allItems });\r\n\r\n    } catch (error) {\r\n        console.error('OCR API Error:', error);\r\n        return NextResponse.json(\r\n            { error: 'OCR 처리 중 오류가 발생했습니다.' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc;AACjD,qCAAqC;AACrC,MAAM,iBAAiB;AAQhB,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,IAAI,CAAC,gBAAgB;YACjB,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,QAAQ,IAAI;QAErC,IAAI,CAAC,UAAU,CAAC,MAAM,OAAO,CAAC,WAAW,OAAO,MAAM,KAAK,GAAG;YAC1D,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAmB,GAC5B;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,WAAsB,EAAE;QAE9B,KAAK,MAAM,eAAe,OAAQ;YAC9B,yBAAyB;YACzB,MAAM,aAAa,YAAY,OAAO,CAAC,4BAA4B;YAEnE,MAAM,SAAS,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;yCA0Ba,CAAC;YAE9B,MAAM,WAAW,MAAM,MAAM,GAAG,eAAe,KAAK,EAAE,gBAAgB,EAAE;gBACpE,QAAQ;gBACR,SAAS;oBACL,gBAAgB;gBACpB;gBACA,MAAM,KAAK,SAAS,CAAC;oBACjB,UAAU;wBAAC;4BACP,OAAO;gCACH;oCAAE,MAAM;gCAAO;gCACf;oCACI,aAAa;wCACT,WAAW;wCACX,MAAM;oCACV;gCACJ;6BACH;wBACL;qBAAE;oBACF,kBAAkB;wBACd,aAAa;wBACb,iBAAiB;oBACrB;gBACJ;YACJ;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBACd,MAAM,YAAY,MAAM,SAAS,IAAI;gBACrC,QAAQ,KAAK,CAAC,qBAAqB;gBACnC;YACJ;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,cAAc,KAAK,UAAU,EAAE,CAAC,EAAE,EAAE,SAAS,OAAO,CAAC,EAAE,EAAE,QAAQ;YAEvE,aAAa;YACb,IAAI;gBACA,gBAAgB;gBAChB,IAAI,UAAU,YAAY,IAAI;gBAC9B,IAAI,QAAQ,UAAU,CAAC,YAAY;oBAC/B,UAAU,QAAQ,OAAO,CAAC,eAAe,IAAI,OAAO,CAAC,WAAW;gBACpE,OAAO,IAAI,QAAQ,UAAU,CAAC,QAAQ;oBAClC,UAAU,QAAQ,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,WAAW;gBAChE;gBAEA,MAAM,QAAQ,KAAK,KAAK,CAAC;gBACzB,IAAI,MAAM,OAAO,CAAC,QAAQ;oBACtB,SAAS,IAAI,IAAI,MAAM,GAAG,CAAC,CAAC,OAAkB,CAAC;4BAC3C,UAAU,KAAK,QAAQ,IAAI;4BAC3B,UAAU,KAAK,QAAQ,IAAI;4BAC3B,QAAQ,OAAO,KAAK,MAAM,KAAK,WAAW,KAAK,MAAM,GAAG,SAAS,OAAO,KAAK,MAAM,EAAE,OAAO,CAAC,WAAW,QAAQ;wBACpH,CAAC,GAAG,MAAM,CAAC,CAAC,OAAkB,KAAK,MAAM,GAAG;gBAChD;YACJ,EAAE,OAAO,YAAY;gBACjB,QAAQ,KAAK,CAAC,qBAAqB,YAAY,YAAY;YAC/D;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAS;IAE/C,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAuB,GAChC;YAAE,QAAQ;QAAI;IAEtB;AACJ","debugId":null}}]
}